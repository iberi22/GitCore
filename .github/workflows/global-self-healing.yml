name: Global Self-Healing Monitor

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # Required to create/update issues
  pull-requests: read  # Required to read PR status

jobs:
  monitor-repos:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        repo:
          - iberi22/Git-Core-Protocol
          - iberi22/software-factory
          - iberi22/domus-otec
          - iberi22/less-colegio
          - iberi22/synapse-protocol
          - iberi22/gara-g
          - iberi22/AI-Chef
          - iberi22/contratafacil
          - iberi22/bestof-opensorce
          - iberi22/obs-studio-agent
          - iberi22/pocket_cerebro
      fail-fast: false
      max-parallel: 3
    
    steps:
      - name: Check Failures
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking ${{ matrix.repo }} for failures..."
          
          # Check the last 10 runs to find any recent failures
          RUN_ID=$(gh run list \
            --repo ${{ matrix.repo }} \
            --limit 10 \
            --json databaseId,conclusion \
            --jq 'map(select(.conclusion == "failure")) | .[0].databaseId' 2>/dev/null || echo "")
          
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No failures found in last 10 runs"
            echo "has_failure=false" >> $GITHUB_OUTPUT
          else
            echo "Found failure: Run ID $RUN_ID"
            echo "has_failure=true" >> $GITHUB_OUTPUT
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Issue
        if: steps.check.outputs.has_failure == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID="${{ steps.check.outputs.run_id }}"
          REPO="${{ matrix.repo }}"
          
          WORKFLOW_NAME=$(gh run view $RUN_ID \
            --repo $REPO \
            --json name \
            --jq '.name' 2>/dev/null || echo "Unknown Workflow")
          
          EXISTING=$(gh issue list \
            --repo $REPO \
            --label "bug" \
            --search "in:title $WORKFLOW_NAME" \
            --state open \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
            echo "Updating issue #$EXISTING"
            gh issue comment $EXISTING --repo $REPO --body "New failure: https://github.com/$REPO/actions/runs/$RUN_ID"
          else
            echo "Creating new issue"
            gh issue create \
              --repo $REPO \
              --title "CI Failure: $WORKFLOW_NAME" \
              --body "Workflow failed. Run: https://github.com/$REPO/actions/runs/$RUN_ID" \
              --label "bug,ai-plan" || echo "Could not create issue"
          fi
