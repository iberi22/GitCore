name: ðŸŒ Global Self-Healing Monitor

on:
  schedule:
    # Ejecutar cada 30 minutos
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Target repos (comma-separated, empty = all)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  monitor-all-repos:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        repo:
          - iberi22/Git-Core-Protocol
          - iberi22/software-factory
          - iberi22/domus-otec
          - iberi22/less-colegio
          - iberi22/synapse-protocol
          - iberi22/gara-g
          - iberi22/AI-Chef
          - iberi22/contratafacil
          - iberi22/bestof-opensorce
          - iberi22/obs-studio-agent
          - iberi22/pocket_cerebro
      fail-fast: false
      max-parallel: 3

    steps:
      - name: ðŸ” Check Recent Failures
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking ${{ matrix.repo }} for failures..."
          
          # Obtener Ãºltimos 10 workflows runs con manejo de errores
          FAILURES=$(gh run list \
            --repo ${{ matrix.repo }} \
            --limit 10 \
            --json conclusion \
            --jq '[.[] | select(.conclusion == "failure")] | length' 2>/dev/null || echo "0")
          
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          
          # ComparaciÃ³n numÃ©rica segura
          if [ ! -z "$FAILURES" ] && [ "$FAILURES" != "0" ]; then
            echo "âš ï¸ Found $FAILURES failed runs"
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No failures found"
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ”¬ Analyze Failure Type
        if: steps.check.outputs.has_failures == 'true'
        id: analyze
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Analyzing failure in ${{ matrix.repo }}..."

          # Obtener el Ãºltimo workflow fallido
          RUN_ID=$(gh run list \
            --repo ${{ matrix.repo }} \
            --limit 1 \
            --json databaseId,conclusion \
            --jq '.[] | select(.conclusion == "failure") | .databaseId')

          if [ -z "$RUN_ID" ]; then
            echo "No run ID found"
            exit 0
          fi

          # Intentar obtener logs
          LOGS=$(gh run view $RUN_ID --repo ${{ matrix.repo }} --log 2>&1 || echo "")

          # Clasificar error
          if echo "$LOGS" | grep -qiE "ETIMEDOUT|ECONNRESET|429|rate limit"; then
            echo "error_type=transient" >> $GITHUB_OUTPUT
            echo "action=retry" >> $GITHUB_OUTPUT
          elif echo "$LOGS" | grep -qiE "npm ERR|yarn error|pip.*failed"; then
            echo "error_type=dependency" >> $GITHUB_OUTPUT
            echo "action=fix_deps" >> $GITHUB_OUTPUT
          elif echo "$LOGS" | grep -qiE "lint|prettier|eslint"; then
            echo "error_type=lint" >> $GITHUB_OUTPUT
            echo "action=fix_lint" >> $GITHUB_OUTPUT
          elif echo "$LOGS" | grep -qiE "test.*failed|FAIL|AssertionError"; then
            echo "error_type=test" >> $GITHUB_OUTPUT
            echo "action=create_issue" >> $GITHUB_OUTPUT
          else
            echo "error_type=unknown" >> $GITHUB_OUTPUT
            echo "action=create_issue" >> $GITHUB_OUTPUT
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: ðŸ”„ Auto-Retry Transient Errors
        if: steps.analyze.outputs.action == 'retry'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ”„ Retrying failed workflow in ${{ matrix.repo }}..."

          gh run rerun ${{ steps.analyze.outputs.run_id }} \
            --repo ${{ matrix.repo }} \
            --failed || echo "âš ï¸ Could not rerun workflow"

      - name: ðŸ“‹ Create Issue for Non-Transient Errors
        if: steps.analyze.outputs.action == 'create_issue' && steps.check.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ“‹ Creating issue in ${{ matrix.repo }}..."

          WORKFLOW_NAME=$(gh run list \
            --repo ${{ matrix.repo }} \
            --limit 1 \
            --json workflowName,conclusion \
            --jq '.[] | select(.conclusion == "failure") | .workflowName')

          RUN_ID="${{ steps.analyze.outputs.run_id }}"
          REPO="${{ matrix.repo }}"
          ERROR_TYPE="${{ steps.analyze.outputs.error_type }}"

          # Verificar si ya existe un issue similar
          EXISTING=$(gh issue list \
            --repo $REPO \
            --label "bug" \
            --search "in:title $WORKFLOW_NAME" \
            --state open \
            --json number \
            --jq '.[0].number')

          ISSUE_BODY="Workflow \`$WORKFLOW_NAME\` failed in \`$REPO\`.

**Run:** https://github.com/$REPO/actions/runs/$RUN_ID
**Error Type:** $ERROR_TYPE

**Detected by:** Global Self-Healing Monitor

### Next Steps
- [ ] Review failure logs
- [ ] Determine root cause
- [ ] Apply fix
- [ ] Verify workflow passes"

          if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
            echo "Issue already exists: #$EXISTING"
            gh issue comment $EXISTING \
              --repo $REPO \
              --body "ðŸ”„ New failure detected. Run: https://github.com/$REPO/actions/runs/$RUN_ID"
          else
            gh issue create \
              --repo $REPO \
              --title "ðŸš¨ CI Failure: $WORKFLOW_NAME" \
              --body "$ISSUE_BODY" \
              --label "bug,ai-plan"
          fi

  summary:
    needs: monitor-all-repos
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŒ Global Self-Healing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitored 11 repositories for workflow failures." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
