name: ðŸ“§ Email Notification Cleanup

on:
  schedule:
    # Ejecutar cada hora
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      max_emails:
        description: 'Maximum emails to process'
        required: false
        default: '50'
        type: string

permissions:
  contents: read

jobs:
  cleanup-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          cd tools/email-handler
          pip install -r requirements.txt
      
      - name: ðŸ” Setup Gmail Credentials
        env:
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          cd tools/email-handler
          
          # Crear credentials.json desde secret
          echo "$GMAIL_CREDENTIALS" > credentials.json
          
          # Crear token.json desde secret si existe
          if [ -n "$GMAIL_TOKEN" ]; then
            echo "$GMAIL_TOKEN" > token.json
          fi
      
      - name: ðŸ“§ Process Notifications
        env:
          GH_TOKEN: ${{ github.token }}
          MAX_EMAILS: ${{ github.event.inputs.max_emails || '50' }}
        run: |
          cd tools/email-handler
          python src/main.py --max-emails $MAX_EMAILS
      
      - name: ðŸ’¾ Update Token (if refreshed)
        if: always()
        run: |
          cd tools/email-handler
          if [ -f token.json ]; then
            echo "Token file exists, should be updated in secrets manually"
            # Note: GitHub Actions cannot update secrets automatically
            # User must copy the new token.json content to GMAIL_TOKEN secret
          fi
      
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“§ Email Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Email handler executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check logs for details on processed emails." >> $GITHUB_STEP_SUMMARY
