name: ðŸš€ Protocol Propagation - Update All Repos

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Target repos (comma-separated, leave empty for all)'
        required: false
        type: string
      update_type:
        description: 'Update type'
        required: true
        type: choice
        options:
          - workflows
          - agents
          - scripts
          - full
        default: 'workflows'
      create_pr:
        description: 'Create PR (true) or Issue (false)'
        required: true
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changed_files: ${{ steps.changes.outputs.files }}
      
    steps:
      - name: ðŸ” Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ðŸ“‹ Get Version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
      
      - name: ðŸ”¬ Detect Changed Files
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Tag push - comparar con tag anterior
            PREV_TAG=$(git tag --sort=-version:refname | sed -n 2p)
            if [ -z "$PREV_TAG" ]; then
              echo "files=all" >> $GITHUB_OUTPUT
            else
              CHANGED=$(git diff --name-only $PREV_TAG HEAD | grep -E '\.github/|scripts/|AGENTS\.md|\.cursorrules' || echo "")
              if [ -z "$CHANGED" ]; then
                echo "files=none" >> $GITHUB_OUTPUT
              else
                echo "files=$CHANGED" >> $GITHUB_OUTPUT
              fi
            fi
          else
            # Manual dispatch
            echo "files=all" >> $GITHUB_OUTPUT
          fi
  
  propagate:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.changed_files != 'none'
    
    strategy:
      matrix:
        repo:
          - iberi22/software-factory
          - iberi22/domus-otec
          - iberi22/less-colegio
          - iberi22/synapse-protocol
          - iberi22/gara-g
          - iberi22/AI-Chef
          - iberi22/contratafacil
          - iberi22/bestof-opensorce
          - iberi22/obs-studio-agent
          - iberi22/pocket_cerebro
      fail-fast: false
      max-parallel: 3
    
    steps:
      - name: ðŸ” Checkout Protocol Repo
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Clone Target Repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh repo clone ${{ matrix.repo }} target-repo || {
            echo "âš ï¸ Cannot access ${{ matrix.repo }}, skipping..."
            exit 0
          }
      
      - name: ðŸ“¦ Prepare Update Package
        id: package
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'workflows' }}"
          VERSION="${{ needs.detect-changes.outputs.version }}"
          
          cd target-repo
          
          # Crear branch de actualizaciÃ³n
          BRANCH_NAME="protocol-update-v${VERSION}"
          git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"
          
          # Determinar quÃ© archivos copiar
          case "$UPDATE_TYPE" in
            workflows)
              echo "ðŸ“‹ Updating workflows..."
              mkdir -p .github/workflows
              cp -r ../.github/workflows/* .github/workflows/ 2>/dev/null || true
              ;;
            agents)
              echo "ðŸ¤– Updating agent configs..."
              cp ../AGENTS.md . 2>/dev/null || true
              cp ../.cursorrules . 2>/dev/null || true
              cp -r ../.github/copilot-instructions.md .github/ 2>/dev/null || true
              ;;
            scripts)
              echo "ðŸ“œ Updating scripts..."
              mkdir -p scripts
              cp -r ../scripts/* scripts/ 2>/dev/null || true
              ;;
            full)
              echo "ðŸ”„ Full protocol update..."
              cp ../AGENTS.md . 2>/dev/null || true
              cp ../.cursorrules . 2>/dev/null || true
              mkdir -p .github/workflows scripts
              cp -r ../.github/workflows/* .github/workflows/ 2>/dev/null || true
              cp -r ../.github/copilot-instructions.md .github/ 2>/dev/null || true
              cp -r ../scripts/* scripts/ 2>/dev/null || true
              ;;
          esac
          
          # Verificar si hay cambios
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No changes detected for ${{ matrix.repo }}"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            
            # Commit cambios
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: update Git-Core Protocol to v${VERSION}

Updates from iberi22/Git-Core-Protocol@v${VERSION}

Update type: ${UPDATE_TYPE}
Changed files: ${{ needs.detect-changes.outputs.changed_files }}

Co-authored-by: Git-Core-Protocol <noreply@github.com>"
          fi
          
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¤ Push Changes
        if: steps.package.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd target-repo
          git push -u origin ${{ steps.package.outputs.branch }} --force
      
      - name: ðŸ“ Create PR
        if: steps.package.outputs.has_changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event.inputs.create_pr == '')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd target-repo
          
          VERSION="${{ needs.detect-changes.outputs.version }}"
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'workflows' }}"
          
          # Generar changelog de cambios
          CHANGELOG="See full changelog: https://github.com/iberi22/Git-Core-Protocol/releases/tag/v${VERSION}"
          
          gh pr create \
            --title "ðŸš€ Git-Core Protocol v${VERSION} Update" \
            --body "## Git-Core Protocol Update

**Version:** v${VERSION}
**Update Type:** ${UPDATE_TYPE}

### Changes
This PR updates the Git-Core Protocol files to the latest version.

### What's Included
$(case "$UPDATE_TYPE" in
  workflows) echo "- âœ… GitHub Actions workflows (self-healing, CI/CD, etc.)" ;;
  agents) echo "- âœ… Agent configuration (AGENTS.md, .cursorrules, copilot-instructions.md)" ;;
  scripts) echo "- âœ… Helper scripts (deployment, telemetry, etc.)" ;;
  full) echo "- âœ… Complete protocol update (workflows, agents, scripts)" ;;
esac)

### Documentation
- ðŸ“– [Protocol Documentation](https://github.com/iberi22/Git-Core-Protocol)
- ðŸ“‹ [Changelog](https://github.com/iberi22/Git-Core-Protocol/blob/main/CHANGELOG.md)
- ðŸ”§ ${CHANGELOG}

### Testing
- [ ] Review changes
- [ ] Run tests
- [ ] Verify workflows

**Auto-generated by Git-Core Protocol Propagation**
" \
            --label "dependencies,protocol-update" \
            --base main \
            --head ${{ steps.package.outputs.branch }} || echo "âš ï¸ PR already exists or error creating PR"
      
      - name: ðŸ“‹ Create Issue (Alternative)
        if: steps.package.outputs.has_changes == 'true' && github.event.inputs.create_pr == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd target-repo
          
          VERSION="${{ needs.detect-changes.outputs.version }}"
          
          gh issue create \
            --title "ðŸ“¦ Git-Core Protocol v${VERSION} Available" \
            --body "A new version of Git-Core Protocol is available. Branch \`${{ steps.package.outputs.branch }}\` has been created with the updates. Review and merge when ready." \
            --label "enhancement,protocol-update"
  
  summary:
    needs: [detect-changes, propagate]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸš€ Protocol Propagation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.detect-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Files:** ${{ needs.detect-changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
